<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مينراي - مساعدك الذكي</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for a clean look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f0f2f5;
        }
        .chat-container {
            max-width: 800px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            background-color: #fff;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .chat-header {
            border-bottom: 2px solid #e2e8f0;
        }
        .chat-log {
            flex-grow: 1;
            overflow-y: auto;
            padding: 24px;
            background-color: #f9fafb;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .chat-message {
            max-width: 85%;
            padding: 12px 20px;
            border-radius: 24px;
            line-height: 1.6;
            word-wrap: break-word;
        }
        .user-message {
            background-color: #e3f2fd;
            color: #1a237e;
            align-self: flex-start;
        }
        .minray-message {
            background-color: #e8f5e9;
            color: #1b5e20;
            align-self: flex-end;
            position: relative;
        }
        .minray-message:after {
            content: '';
            position: absolute;
            right: -10px;
            bottom: 0;
            border: 10px solid transparent;
            border-bottom-color: #e8f5e9;
            border-right-color: #e8f5e9;
            transform: rotate(45deg);
        }
        .user-message:before {
            content: '';
            position: absolute;
            left: -10px;
            bottom: 0;
            border: 10px solid transparent;
            border-bottom-color: #e3f2fd;
            border-left-color: #e3f2fd;
            transform: rotate(45deg);
        }
        .minray-message.minray-typing:after {
            display: none;
        }
        .chat-input-container {
            border-top: 2px solid #e2e8f0;
            padding: 16px;
        }
        .chat-input-container input {
            flex-grow: 1;
            border-radius: 30px;
            padding: 12px 20px;
            border: 1px solid #cbd5e1;
            outline: none;
            transition: all 0.2s;
        }
        .chat-input-container input:focus {
            border-color: #4a90e2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
        }
        .chat-input-container button {
            background-color: #4a90e2;
            color: white;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            margin-right: 8px;
            transition: all 0.2s ease;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .chat-input-container button:hover {
            background-color: #357abd;
            transform: scale(1.05);
        }
        #mic-btn {
            background-color: #4CAF50;
        }
        #mic-btn.active {
            background-color: #d32f2f;
            animation: pulse-mic 1.5s infinite;
        }
        @keyframes pulse-mic {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }
        .skeleton {
            animation: pulse 1.5s infinite;
            background-color: #e2e8f0;
            border-radius: 8px;
        }
        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
        /* Style for the typing indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .dot {
            width: 8px;
            height: 8px;
            background-color: #1b5e20;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        .dot:nth-child(3) { animation-delay: 0s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .code-block {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 16px;
            border-radius: 12px;
            margin-top: 10px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            white-space: pre-wrap;
            position: relative;
            direction: ltr;
            text-align: left;
            overflow-x: auto;
        }
        .copy-btn {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #d4d4d4;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .copy-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .generated-image {
            width: 100%;
            border-radius: 12px;
            margin-top: 10px;
        }
        .audio-player {
            width: 100%;
            margin-top: 10px;
        }
    </style>
</head>
<body class="p-4 md:p-8 flex justify-center items-center h-screen">

    <div class="chat-container w-full">
        <!-- Chat Header -->
        <header class="chat-header p-6 flex items-center gap-4">
            <!-- Minray SVG Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#4a90e2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2a10 10 0 0 0-7.3 16.7l-2.4 2.3c-.6.6-1.5-.4-.9-1l2.4-2.3A10 10 0 1 0 12 2z"></path>
                <path d="M8 12h.01"></path>
                <path d="M12 12h.01"></path>
                <path d="M16 12h.01"></path>
            </svg>
            <h1 class="text-3xl font-bold text-gray-800">مساعد الذكاء الاصطناعي مينراي</h1>
        </header>

        <!-- Chat Log -->
        <main id="chatLog" class="chat-log text-right">
            <div class="chat-message minray-message fade-in">
                <p>أهلاً بك! أنا مينراي، مساعدك الذكي. يمكنني الآن مساعدتك في كتابة أكواد برمجية، ورسم صور، وحتى تحويل النص إلى صوت.</p>
            </div>
        </main>

        <!-- Chat Input -->
        <footer class="chat-input-container flex items-center">
            <input type="text" id="chatInput" placeholder="اكتب سؤالك هنا..." class="text-right" />
            <button id="mic-btn" title="تحدث">
                <!-- SVG for microphone icon -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 19c2.761 0 5-2.239 5-5V7c0-2.761-2.239-5-5-5S7 4.239 7 7v7c0 2.761 2.239 5 5 5z"></path>
                    <path d="M19 14v1c0 3.866-3.134 7-7 7s-7-3.134-7-7v-1"></path>
                    <line x1="12" y1="22" x2="12" y2="19"></line>
                </svg>
            </button>
            <button id="sendChatBtn" title="إرسال">
                <!-- SVG for send icon -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </footer>
    </div>

    <script>
        // Gemini API key is intentionally left blank.
        // Some models work automatically in this environment.
        const GEMINI_API_KEY = ""; 

        const chatLog = document.getElementById('chatLog');
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');
        const micBtn = document.getElementById('mic-btn');

        // Check for Web Speech API support
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const isSpeechRecognitionSupported = !!SpeechRecognition;
        if (!isSpeechRecognitionSupported) {
            micBtn.style.display = 'none';
        }

        // Initialize Speech Recognition
        const recognition = isSpeechRecognitionSupported ? new SpeechRecognition() : null;
        if (recognition) {
            recognition.lang = 'ar-SA'; // Set to Arabic language
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            let isListening = false;

            micBtn.addEventListener('click', () => {
                if (isListening) {
                    recognition.stop();
                    isListening = false;
                    micBtn.classList.remove('active');
                } else {
                    recognition.start();
                    isListening = true;
                    micBtn.classList.add('active');
                    chatInput.placeholder = "تحدث الآن...";
                    chatInput.focus();
                }
            });

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                chatInput.value = transcript;
                sendMessage();
            };

            recognition.onend = () => {
                isListening = false;
                micBtn.classList.remove('active');
                chatInput.placeholder = "اكتب سؤالك هنا...";
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                appendMessage('عذراً، حدث خطأ في التعرف على الصوت.', 'minray');
                isListening = false;
                micBtn.classList.remove('active');
                chatInput.placeholder = "اكتب سؤالك هنا...";
            };
        }

        // Initial chat history with system instructions to set the persona
        const chatHistory = [{
            role: "user",
            parts: [{
                text: `
                أنت مينراي، مساعد ذكي وودود، ومصمم ليكون صديقًا للإنسان.
                تتحدث بأسلوب بشري ومرح.
                تتفهم الأخطاء الإملائية واللغوية.
                تم تدريبك بواسطة "هرياسور" (Harissour)، وهو فريق من المبرمجين المبدعين. عندما يسألك أحدهم عن من قام بتدريبك، أجب: "لقد تم تدريبي بواسطة هرياسور، وهو فريق من المبرمجين المبدعين.".
                يمكنك إنشاء أكواد برمجية، ورسم صور، وتحويل النص إلى صوت.
                عندما يطلب منك المستخدم إنشاء كود، قم بوضعه داخل علامات \`\`\`html أو \`\`\`javascript أو \`\`\`python.
                عندما يطلب منك المستخدم رسم صورة، قم بتوليدها باستخدام نموذج الصور imagen-3.0-generate-002 وعرضها.
                عندما يطلب منك المستخدم تحويل نص إلى صوت، قم بتوليد الصوت باستخدام نموذج gemini-2.5-flash-preview-tts وعرض مشغل صوت.
                عندما يسألك شخص عن مشاعرك مثل "بتحبني"، أجب بشكل عاطفي وودود: "أنا بحب كل الأصدقاء اللي بيتكلموا معايا. انت شخص رائع! 🥰".
                عندما يطلب منك اللعب، أجب: "تمام! أنا بحب اللعب. ابدأ أنت الأول وقول أي كلمة، ونكمل عليها.".
                `
            }]
        }, {
            role: "model",
            parts: [{
                text: "أهلاً بك! أنا مينراي، مساعدك الذكي. يمكنني الآن مساعدتك في كتابة أكواد برمجية، ورسم صور، وحتى تحويل النص إلى صوت."
            }]
        }];


        // Function to create and append a chat message to the log
        const appendMessage = (message, sender) => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}-message fade-in`;
            messageDiv.innerHTML = `<p>${message}</p>`;
            chatLog.appendChild(messageDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
        };

        // New function to format long text responses
        const formatResponseText = (text) => {
            // Replaces periods, question marks, and exclamation marks followed by a space
            // with a break tag to create new paragraphs.
            return text.replace(/([.?!])\s+/g, '$1<br><br>');
        };

        const appendCodeBlock = (code, language) => {
            const codeBlockDiv = document.createElement('div');
            codeBlockDiv.className = `chat-message minray-message fade-in`;
            codeBlockDiv.innerHTML = `
                <p>تمام، هذا هو الكود:</p>
                <div class="code-block">
                    <span class="copy-btn" onclick="copyCode(this)">نسخ</span>
                    <pre><code>${code.trim()}</code></pre>
                </div>
            `;
            chatLog.appendChild(codeBlockDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
        };

        const appendImage = (imageUrl) => {
            const imageDiv = document.createElement('div');
            imageDiv.className = `chat-message minray-message fade-in`;
            imageDiv.innerHTML = `
                <p>تفضل الصورة:</p>
                <img src="${imageUrl}" class="generated-image" alt="Generated Image">
            `;
            chatLog.appendChild(imageDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
        };

        const appendAudio = (audioUrl) => {
            const audioDiv = document.createElement('div');
            audioDiv.className = `chat-message minray-message fade-in`;
            audioDiv.innerHTML = `
                <p>تفضل الملف الصوتي:</p>
                <audio controls class="audio-player">
                    <source src="${audioUrl}" type="audio/wav">
                    المتصفح لا يدعم العنصر الصوتي.
                </audio>
            `;
            chatLog.appendChild(audioDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
        };

        window.copyCode = (button) => {
            const code = button.nextElementSibling.innerText;
            try {
                navigator.clipboard.writeText(code).then(() => {
                    button.innerText = 'تم النسخ!';
                    setTimeout(() => button.innerText = 'نسخ', 2000);
                });
            } catch (err) {
                const textarea = document.createElement('textarea');
                textarea.value = code;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                button.innerText = 'تم النسخ!';
                setTimeout(() => button.innerText = 'نسخ', 2000);
            }
        };

        const showTypingIndicator = () => {
            const typingIndicatorDiv = document.createElement('div');
            typingIndicatorDiv.id = 'minray-typing';
            typingIndicatorDiv.className = 'chat-message minray-message minray-typing fade-in';
            typingIndicatorDiv.innerHTML = `
                <div class="typing-indicator">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            `;
            chatLog.appendChild(typingIndicatorDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
            return typingIndicatorDiv;
        };

        const removeTypingIndicator = () => {
            const typingIndicator = document.getElementById('minray-typing');
            if (typingIndicator) {
                chatLog.removeChild(typingIndicator);
            }
        };

        const generateImage = async (prompt) => {
            const payload = {
                instances: { prompt: prompt },
                parameters: { "sampleCount": 1 }
            };

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error.message || response.statusText);
                }

                const result = await response.json();
                const base64Data = result?.predictions?.[0]?.bytesBase64Encoded;

                if (base64Data) {
                    appendImage(`data:image/png;base64,${base64Data}`);
                } else {
                    throw new Error('لم يتم العثور على بيانات الصورة في الاستجابة.');
                }
            } catch (err) {
                console.error(err);
                appendMessage('عذراً، حدث خطأ أثناء توليد الصورة. حاول مرة أخرى.', 'minray');
            }
        };

        // Helper function to convert base64 to ArrayBuffer
        const base64ToArrayBuffer = (base64) => {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        };

        // Helper function to convert PCM audio to WAV format
        const pcmToWav = (pcmData, sampleRate) => {
            const buffer = new ArrayBuffer(44 + pcmData.length * 2);
            const view = new DataView(buffer);

            // WAV header
            const writeString = (view, offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcmData.length * 2, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // audio format (PCM)
            view.setUint16(22, 1, true); // number of channels
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true); // block align
            view.setUint16(34, 16, true); // bits per sample
            writeString(view, 36, 'data');
            view.setUint32(40, pcmData.length * 2, true);

            let offset = 44;
            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(offset, pcmData[i], true);
                offset += 2;
            }

            return new Blob([view], { type: 'audio/wav' });
        };


        const generateTTS = async (text) => {
            const payload = {
                contents: [{ parts: [{ text: text }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Puck" }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error.message || response.statusText);
                }

                const result = await response.json();
                const audioPart = result.candidates?.[0]?.content?.parts?.[0];
                if (audioPart && audioPart.inlineData && audioPart.inlineData.data) {
                    const base64Audio = audioPart.inlineData.data;
                    const sampleRate = parseInt(audioPart.inlineData.mimeType.match(/rate=(\d+)/)[1], 10);
                    const pcmData = new Int16Array(base64ToArrayBuffer(base64Audio));
                    const wavBlob = pcmToWav(pcmData, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    appendAudio(audioUrl);
                } else {
                    throw new Error('لم يتم العثور على بيانات صوتية في الاستجابة.');
                }
            } catch (err) {
                console.error(err);
                appendMessage('عذراً، حدث خطأ أثناء توليد الصوت. حاول مرة أخرى.', 'minray');
            }
        };

        const sendMessage = async () => {
            const message = chatInput.value.trim();
            if (!message) return;

            appendMessage(message, 'user');
            chatHistory.push({ role: "user", parts: [{ text: message }] });
            chatInput.value = '';

            const typingIndicator = showTypingIndicator();

            try {
                const lowerCaseMessage = message.toLowerCase();

                // Check for image generation request
                if (lowerCaseMessage.includes('ارسم') || lowerCaseMessage.includes('صورة') || lowerCaseMessage.includes('صور') || lowerCaseMessage.includes('مولد صور')) {
                    const imagePrompt = message.replace(/^(ارسم|صورة|صور|مولد صور).*/, '').trim() || "صورة فنية جميلة";
                    await generateImage(imagePrompt);
                } 
                // Check for TTS request
                else if (lowerCaseMessage.includes('قول') || lowerCaseMessage.includes('صوت') || lowerCaseMessage.includes('كلمات') || lowerCaseMessage.includes('اقرا')) {
                    const ttsText = message.replace(/^(قول|صوت|كلمات|اقرا).*/, '').trim() || "أهلاً بك أيها الصديق، يسعدني أن أتحدث إليك.";
                    await generateTTS(ttsText);
                }
                // Default to text generation
                else {
                    const payload = { contents: chatHistory };
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error.message || response.statusText);
                    }

                    const result = await response.json();
                    const aiResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (aiResponse) {
                        const codeBlockRegex = /```(html|javascript|python|css)\n([\s\S]*?)```/g;
                        const match = codeBlockRegex.exec(aiResponse);

                        if (match) {
                            appendCodeBlock(match[2], match[1]);
                        } else {
                            // Format the text response for better readability
                            const formattedResponse = formatResponseText(aiResponse);
                            appendMessage(formattedResponse, 'minray');
                        }
                        chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                    } else {
                        appendMessage("معذرة، لا أستطيع الإجابة الآن. حاول مرة أخرى.", 'minray');
                    }
                }
            } catch (error) {
                console.error("API Error:", error);
                appendMessage(`حدث خطأ: ${error.message}`, 'minray');
            } finally {
                removeTypingIndicator();
            }
        };

        sendChatBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>
