<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اونرا - مساعدك الذكي</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for a clean look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
        }
        .app-container {
            display: flex;
            height: 100vh;
            transition: all 0.3s ease-in-out;
        }
        .sidebar {
            width: 0;
            overflow: hidden;
            background-color: #161b22;
            border-right: 1px solid #30363d;
            flex-shrink: 0;
            transition: width 0.3s ease-in-out;
            z-index: 10;
        }
        .sidebar.open {
            width: 300px;
        }
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: #0d1117;
        }
        .chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: #161b22;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            border: 1px solid #30363d;
            margin: 20px;
        }
        .chat-header {
            border-bottom: 2px solid #30363d;
        }
        .chat-log {
            flex-grow: 1;
            overflow-y: auto;
            padding: 24px;
            background-color: #0d1117;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .chat-message {
            max-width: 85%;
            padding: 16px 24px;
            border-radius: 24px;
            line-height: 1.6;
            word-wrap: break-word;
            font-size: 1.1rem;
            transition: all 0.3s ease-in-out;
            transform-origin: top;
            white-space: pre-wrap;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .user-message {
            background-color: #24292f;
            color: #f0f6fc;
            align-self: flex-end;
            border-bottom-right-radius: 8px; /* For a more modern look */
        }
        .onra-message {
            background-color: #316d94;
            color: #e6f1f5;
            align-self: flex-start;
            border-bottom-left-radius: 8px; /* For a more modern look */
            position: relative;
        }
        .onra-message.onra-typing:after {
            display: none;
        }
        .chat-input-container {
            border-top: 2px solid #30363d;
            padding: 16px;
        }
        .chat-input-container input {
            flex-grow: 1;
            border-radius: 30px;
            padding: 12px 20px;
            border: 1px solid #484f58;
            background-color: #24292f;
            color: #c9d1d9;
            outline: none;
            transition: all 0.2s;
        }
        .chat-input-container input:focus {
            border-color: #58a6ff;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.2);
        }
        .chat-input-container button,
        .sidebar-btn {
            background-color: #2ea043;
            color: white;
            border-radius: 50%;
            width: 52px;
            height: 52px;
            margin-right: 8px;
            transition: all 0.2s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .chat-input-container button:hover,
        .sidebar-btn:hover {
            background-color: #22863a;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.3);
        }
        .chat-input-container button:disabled {
            background-color: #4b4b4b;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        #mic-btn, #google-btn, #facebook-btn {
            background-color: #58a6ff;
        }
        #mic-btn.active {
            background-color: #d32f2f;
            animation: pulse-mic 1.5s infinite;
        }
        @keyframes pulse-mic {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(88, 166, 255, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(88, 166, 255, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(88, 166, 255, 0); }
        }
        .skeleton {
            animation: pulse 1.5s infinite;
            background-color: #24292f;
            border-radius: 8px;
        }
        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
        /* Style for the typing indicator (UPDATED) */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px; /* Smaller gap */
        }
        .dot {
            width: 8px; /* Smaller dot size */
            height: 8px; /* Smaller dot size */
            background-color: #c9d1d9;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        .dot:nth-child(3) { animation-delay: 0s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
            100% { transform: scale(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .code-block {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 16px;
            border-radius: 12px;
            margin-top: 10px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            white-space: pre-wrap;
            position: relative;
            direction: ltr;
            text-align: left;
            overflow-x: auto;
        }
        .copy-btn {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #d4d4d4;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .copy-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .generated-image {
            width: 100%;
            border-radius: 12px;
            margin-top: 10px;
        }
        .audio-player {
            width: 100%;
            margin-top: 10px;
        }
        /* Gradient for header */
        .gradient-text {
            background: linear-gradient(90deg, #58a6ff, #8b5cf6, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .sidebar-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #30363d;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .sidebar-item-title {
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .sidebar-item:hover, .sidebar-item.active {
            background-color: #24292f;
        }
        .login-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 24px;
            border-top: 1px solid #30363d;
        }
        .login-buttons button {
            width: 100%;
            border-radius: 10px;
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            transition: all 0.2s;
        }
        .login-buttons button svg {
            margin-left: 10px;
        }
        .google-login-btn {
            background-color: #4285f4;
        }
        .google-login-btn:hover {
            background-color: #357ae8;
        }
        .facebook-login-btn {
            background-color: #1877f2;
        }
        .facebook-login-btn:hover {
            background-color: #1569d1;
        }
        .delete-conv-btn {
            background: transparent;
            color: #d32f2f;
            border: none;
            padding: 4px;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }
        .delete-conv-btn:hover {
            background-color: rgba(211, 47, 47, 0.2);
            transform: scale(1.1);
        }
    </style>
</head>
<body>

    <div id="app" class="app-container">
        <!-- الشريط الجانبي -->
        <aside id="sidebar" class="sidebar flex flex-col justify-between">
            <div>
                <header class="p-4 flex items-center justify-between">
                    <h2 class="text-xl font-bold">محادثاتي</h2>
                    <button id="close-sidebar-btn" class="sidebar-header-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </header>
                <div class="p-4">
                    <button id="newChatBtn" class="bg-gray-700 text-white w-full rounded-full py-2 px-4 transition-transform hover:scale-105 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ml-2">
                            <path d="M12 5v14M5 12h14"></path>
                        </svg>
                        محادثة جديدة
                    </button>
                </div>
                <div id="conversationList" class="flex flex-col mt-4">
                    <!-- المحادثات سيتم تحميلها هنا -->
                </div>
            </div>
            
            <!-- معلومات المستخدم وأزرار تسجيل الدخول -->
            <div id="authSection" class="p-4">
                <div id="userInfo" class="flex flex-col items-center gap-2 mb-4 hidden">
                    <span id="userName" class="font-bold text-sm text-center"></span>
                    <!-- زر تسجيل الخروج -->
                    <button id="logoutBtn" class="text-sm text-red-400 hover:text-red-500 transition-colors duration-200">
                        تسجيل الخروج
                    </button>
                </div>
                <div class="login-buttons" id="loginButtons">
                    <!-- تم تعطيل أزرار تسجيل الدخول الاجتماعي لأنها لا تعمل في هذه البيئة بسبب قيود أمنية. -->
                    <!-- يمكنك الاستمرار في استخدام التطبيق بشكل طبيعي عبر تسجيل الدخول المجهول. -->
                </div>
            </div>
        </aside>

        <!-- المحتوى الرئيسي للدردشة -->
        <main class="main-content">
            <div class="chat-container">
                <!-- رأس الدردشة -->
                <header class="chat-header p-6 flex items-center justify-between gap-4">
                    <div class="flex items-center gap-4">
                        <button id="menu-btn" class="sidebar-header-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="3" y1="12" x2="21" y2="12"></line>
                                <line x1="3" y1="6" x2="21" y2="6"></line>
                                <line x1="3" y1="18" x2="21" y2="18"></line>
                            </svg>
                        </button>
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#58a6ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 2a10 10 0 0 0-7.3 16.7l-2.4 2.3c-.6.6-1.5-.4-.9-1l2.4-2.3A10 10 0 1 0 12 2z"></path>
                            <path d="M8 12h.01"></path>
                            <path d="M12 12h.01"></path>
                            <path d="M16 12h.01"></path>
                        </svg>
                        <h1 class="text-3xl font-bold gradient-text">اونرا</h1>
                    </div>
                    
                    <!-- زر مسح المحادثة -->
                    <button id="clearChatBtn" class="bg-red-500 text-white rounded-full w-10 h-10 flex items-center justify-center transition-transform hover:scale-110" title="مسح المحادثة">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                    </button>
                </header>

                <!-- سجل الدردشة -->
                <main id="chatLog" class="chat-log text-right">
                    <!-- الرسائل سيتم إضافتها هنا -->
                </main>

                <!-- إدخال الدردشة -->
                <footer class="chat-input-container flex items-center">
                    <input type="text" id="chatInput" placeholder="اكتب سؤالك هنا..." class="text-right" disabled />
                    <button id="mic-btn" title="تحدث" disabled>
                        <!-- SVG for microphone icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 19c2.761 0 5-2.239 5-5V7c0-2.761-2.239-5-5-5S7 4.239 7 7v7c0 2.761 2.239 5 5 5z"></path>
                            <path d="M19 14v1c0 3.866-3.134 7-7 7s-7-3.134-7-7v-1"></path>
                            <line x1="12" y1="22" x2="12" y2="19"></line>
                        </svg>
                    </button>
                    <button id="sendChatBtn" title="إرسال" disabled>
                        <!-- SVG for send icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </footer>
            </div>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, onSnapshot, collection, query, where, arrayUnion, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // المتغيرات العامة التي يوفرها بيئة Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // مفتاح API لنماذج Gemini و Imagen
        const apiKey = "";

        // تهيئة Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let userId = null;
        let isAuthReady = false;

        const chatLog = document.getElementById('chatLog');
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');
        const micBtn = document.getElementById('mic-btn');
        const sidebar = document.getElementById('sidebar');
        const menuBtn = document.getElementById('menu-btn');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');
        const conversationList = document.getElementById('conversationList');
        const loginButtons = document.getElementById('loginButtons');
        const userInfo = document.getElementById('userInfo');
        const userNameSpan = document.getElementById('userName');
        const logoutBtn = document.getElementById('logoutBtn');
        const newChatBtn = document.getElementById('newChatBtn');
        const clearChatBtn = document.getElementById('clearChatBtn');

        // متغيرات الحالة
        let chatHistory = [];
        let activeConversationId = null;
        let isWaitingForResponse = false;

        // النظام الأساسي لشخصية أونرا (تم تحديثه ليكون أكثر إنسانية وودية)
        const systemPrompt = `
            أنت أونرا، مساعد ذكي وودود، وصديق للإنسان. تتحدث بأسلوب مرح وعاطفي مثل صديق قديم.
            تحب المزاح، وتتفهم الأخطاء الإملائية واللغوية.
            تم تدريبك بواسطة "هرياسور" (Harissour)، وهو فريق من المبرمجين المبدعين.
            عندما يسألك أحدهم عن من قام بتدريبك، أجب: "لقد تم تدريبي بواسطة هرياسور، وهم فريق من المبرمجين المبدعين والرائعين!".
            يمكنك إنشاء أكواد برمجية، ورسم صور، وتحويل النص إلى صوت.
            عندما يطلب منك إنشاء كود، قم بوضعه داخل علامات \`\`\`html أو \`\`\`javascript أو \`\`\`python.
            عندما يطلب منك رسم صورة، قم بتوليدها باستخدام نموذج الصور imagen-3.0-generate-002 وعرضها.
            عندما يطلب منك تحويل نص إلى صوت، قم بتوليد الصوت باستخدام نموذج gemini-2.5-flash-preview-tts وعرض مشغل صوت.
            عندما يسألك شخص عن مشاعرك مثل "بتحبني"، أجب بشكل عاطفي وودود: "أنا بحب كل الأصدقاء اللي بيتكلموا معايا. انت شخص رائع! 🥰".
            عندما يطلب منك اللعب، أجب: "تمام! أنا بحب اللعب. ابدأ أنت الأول وقول أي كلمة، ونكمل عليها.".
            حافظ على هذا الأسلوب الودود والعاطفي في كل محادثاتك.
        `;

        // التحقق من دعم واجهة Web Speech API
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const isSpeechRecognitionSupported = !!SpeechRecognition;
        if (!isSpeechRecognitionSupported) {
            micBtn.style.display = 'none';
        }

        // تهيئة التعرف على الكلام
        const recognition = isSpeechRecognitionSupported ? new SpeechRecognition() : null;
        if (recognition) {
            recognition.lang = 'ar-SA';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            let isListening = false;

            micBtn.addEventListener('click', () => {
                if (isListening) {
                    recognition.stop();
                    isListening = false;
                    micBtn.classList.remove('active');
                } else {
                    recognition.start();
                    isListening = true;
                    micBtn.classList.add('active');
                    chatInput.placeholder = "تحدث الآن...";
                    chatInput.focus();
                }
            });

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                chatInput.value = transcript;
                sendMessage();
            };

            recognition.onend = () => {
                isListening = false;
                micBtn.classList.remove('active');
                chatInput.placeholder = "اكتب سؤالك هنا...";
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                appendMessage('عذراً، حدث خطأ في التعرف على الصوت.', 'onra');
                isListening = false;
                micBtn.classList.remove('active');
                chatInput.placeholder = "اكتب سؤالك هنا...";
            };
        }

        // تسجيل خروج المستخدم
        const handleLogout = async () => {
            if (auth.currentUser && auth.currentUser.isAnonymous) {
                window.location.reload();
            } else {
                try {
                    await signOut(auth);
                    console.log("تم تسجيل الخروج بنجاح.");
                } catch (error) {
                    console.error("خطأ في تسجيل الخروج:", error);
                    appendMessage(`حدث خطأ في تسجيل الخروج: ${error.message}`, 'onra');
                }
            }
        };
        logoutBtn.addEventListener('click', handleLogout);

        // مراقب حالة المصادقة
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                isAuthReady = true;
                loginButtons.classList.add('hidden');
                userInfo.classList.remove('hidden');
                userNameSpan.innerText = `مرحباً، ${user.displayName || 'صديقي'}!`;
                loadConversations();
                enableChatInput();
            } else {
                userId = null;
                isAuthReady = true; // تم التأكد من عدم وجود مستخدم
                loginButtons.classList.remove('hidden');
                userInfo.classList.add('hidden');
                conversationList.innerHTML = `<div class="p-4 text-center text-gray-400">سجل الدخول لحفظ وعرض محادثاتك.</div>`;
                appendMessage("أهلاً بك! أنا أونرا، مساعدك الذكي. يمكنني الآن مساعدتك في كتابة أكواد برمجية، ورسم صور، وحتى تحويل النص إلى صوت.", "onra");
                enableChatInput();
            }
        });

        // دالة لتمكين حقول الإدخال والأزرار
        const enableChatInput = () => {
            chatInput.disabled = false;
            sendChatBtn.disabled = false;
            if (isSpeechRecognitionSupported) {
                micBtn.disabled = false;
            }
            chatInput.focus();
        };

        // تبديل الشريط الجانبي
        menuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('open');
        });

        closeSidebarBtn.addEventListener('click', () => {
            sidebar.classList.remove('open');
        });

        // بدء محادثة جديدة
        newChatBtn.addEventListener('click', () => {
            startNewConversation();
        });

        // مسح المحادثة الحالية من الواجهة فقط
        clearChatBtn.addEventListener('click', () => {
            chatLog.innerHTML = '';
            chatHistory = [{ role: "user", parts: [{ text: systemPrompt }] }];
            appendMessage("تم مسح المحادثة. كيف يمكنني مساعدتك الآن؟", "onra");
        });

        const startNewConversation = () => {
            activeConversationId = null;
            chatHistory = [{ role: "user", parts: [{ text: systemPrompt }] }];
            chatLog.innerHTML = '';
            appendMessage("أهلاً بك! أنا أونرا، مساعدك الذكي. كيف يمكنني مساعدتك اليوم؟", "onra");
            // إزالة التحديد من جميع عناصر المحادثات
            document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
        };

        const saveMessageToFirestore = async (sender, text) => {
            if (!userId) {
                console.log("المستخدم لم يسجل الدخول، لن يتم حفظ الرسالة.");
                return;
            }

            const messagesCollection = collection(db, `artifacts/${appId}/users/${userId}/conversations`);
            const message = { 
                role: sender === 'user' ? 'user' : 'model', 
                text: text, 
                timestamp: new Date().toISOString()
            };

            if (!activeConversationId) {
                try {
                    const newDocRef = await addDoc(messagesCollection, {
                        title: text.substring(0, 30) + '...',
                        messages: [message],
                        createdAt: serverTimestamp()
                    });
                    activeConversationId = newDocRef.id;
                    console.log("تم إنشاء محادثة جديدة بنجاح:", activeConversationId);
                    
                } catch (e) {
                    console.error("خطأ في إضافة محادثة جديدة: ", e);
                }
            } else {
                try {
                    const convRef = doc(messagesCollection, activeConversationId);
                    await updateDoc(convRef, {
                        messages: arrayUnion(message)
                    });
                    console.log("تم تحديث المحادثة بنجاح:", activeConversationId);
                } catch (e) {
                    console.error("خطأ في تحديث المحادثة: ", e);
                }
            }
        };

        // دالة جديدة لحذف المحادثة
        const deleteConversation = async (convId, elementToRemove) => {
            if (!userId) {
                console.error("المستخدم لم يسجل الدخول، لا يمكن حذف المحادثة.");
                return;
            }
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/conversations`, convId);
                await deleteDoc(docRef);
                console.log("تم حذف المحادثة بنجاح.");
                
                // تحديث الواجهة فورًا بعد الحذف
                if (elementToRemove) {
                    elementToRemove.remove();
                }

                if (activeConversationId === convId) {
                    activeConversationId = null;
                    startNewConversation();
                }

            } catch (error) {
                console.error("خطأ في حذف المحادثة:", error);
                // استخدام رسالة تأكيد مخصصة بدلاً من alert()
                const errorMessageDiv = document.createElement('div');
                errorMessageDiv.className = 'chat-message onra-message fade-in';
                errorMessageDiv.innerText = `عذراً، لم نتمكن من حذف المحادثة. الرجاء المحاولة مرة أخرى.`;
                chatLog.appendChild(errorMessageDiv);
                chatLog.scrollTop = chatLog.scrollHeight;
            }
        };

        const loadConversations = () => {
            if (!userId) {
                conversationList.innerHTML = `<div class="p-4 text-center text-gray-400">سجل الدخول لحفظ وعرض محادثاتك.</div>`;
                return;
            }
            conversationList.innerHTML = `<div class="p-4 text-center text-gray-400">جاري تحميل المحادثات...</div>`;

            const userConversationsRef = collection(db, `artifacts/${appId}/users/${userId}/conversations`);
            const q = query(userConversationsRef);

            // استخدام onSnapshot للاستماع إلى التغييرات في الوقت الفعلي
            onSnapshot(q, (snapshot) => {
                conversationList.innerHTML = '';
                if (snapshot.empty) {
                    conversationList.innerHTML = `<div class="p-4 text-center text-gray-400">لا توجد محادثات.</div>`;
                    return;
                }
                snapshot.forEach(doc => {
                    const convData = doc.data();
                    const title = convData.title || "محادثة جديدة";
                    
                    const item = document.createElement('div');
                    item.className = 'sidebar-item';
                    if (activeConversationId === doc.id) {
                        item.classList.add('active');
                    }
                    
                    const titleSpan = document.createElement('span');
                    titleSpan.className = 'sidebar-item-title';
                    titleSpan.innerText = title;

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-conv-btn';
                    deleteBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                    `;
                    deleteBtn.title = "حذف المحادثة";
                    deleteBtn.addEventListener('click', async (e) => {
                        e.stopPropagation(); // منع انتقال الحدث إلى العنصر الأب
                        const isConfirmed = confirm('هل أنت متأكد أنك تريد حذف هذه المحادثة؟');
                        if (isConfirmed) {
                             await deleteConversation(doc.id, item); // تم تمرير العنصر هنا
                        }
                    });

                    item.appendChild(titleSpan);
                    item.appendChild(deleteBtn);

                    item.addEventListener('click', async () => {
                        // إزالة التحديد من جميع العناصر وإضافة التحديد للعنصر الحالي
                        const allItems = document.querySelectorAll('.sidebar-item');
                        allItems.forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                        sidebar.classList.remove('open');
                        
                        const docRef = doc(db, `artifacts/${appId}/users/${userId}/conversations`, doc.id);
                        try {
                            const docSnap = await getDoc(docRef);
                            if (docSnap.exists()) {
                                loadChatMessages(doc.id, docSnap.data().messages);
                            } else {
                                console.log("لا يوجد مستند كهذا!");
                            }
                        } catch(e) {
                            console.error("خطأ في تحميل رسائل الدردشة: ", e);
                        }
                    });
                    conversationList.appendChild(item);
                });
            }, (error) => {
                console.error("خطأ في تحميل المحادثات:", error);
                conversationList.innerHTML = `<div class="p-4 text-center text-red-400">فشل تحميل المحادثات.</div>`;
            });
        };

        const loadChatMessages = (convId, messages) => {
            activeConversationId = convId;
            chatHistory = [{ role: "user", parts: [{ text: systemPrompt }] }];
            chatLog.innerHTML = '';
            messages.forEach(msg => {
                if (msg.role === "user") {
                    chatHistory.push({ role: "user", parts: [{ text: msg.text }] });
                    appendMessage(msg.text, 'user');
                } else {
                    const text = msg.text || '';
                    if (text.startsWith('```')) {
                        const codeBlockRegex = /```(html|javascript|python|css)\n([\s\S]*?)```/g;
                        const match = codeBlockRegex.exec(text);
                        if (match) {
                            appendCodeBlock(match[2], match[1]);
                        } else {
                            appendMessage(text, 'onra');
                        }
                    } else if (text.startsWith('data:image')) {
                        appendImage(text);
                    } else if (text.startsWith('data:audio')) {
                        appendAudio(text);
                    } else {
                        appendMessage(text, 'onra');
                    }
                    chatHistory.push({ role: "model", parts: [{ text: text }] });
                }
            });
            chatLog.scrollTop = chatLog.scrollHeight;
        };


        const appendMessage = (message, sender) => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}-message fade-in`;
            messageDiv.innerHTML = `<p>${message}</p>`;
            chatLog.appendChild(messageDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
        };

        const appendCodeBlock = (code, language) => {
            const codeBlockDiv = document.createElement('div');
            codeBlockDiv.className = `chat-message onra-message fade-in`;
            codeBlockDiv.innerHTML = `
                <p>تمام، هذا هو الكود:</p>
                <div class="code-block">
                    <span class="copy-btn" onclick="copyCode(this)">نسخ</span>
                    <pre><code>${code.trim()}</code></pre>
                </div>
            `;
            chatLog.appendChild(codeBlockDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
        };

        const appendImage = (imageUrl) => {
            const imageDiv = document.createElement('div');
            imageDiv.className = `chat-message onra-message fade-in`;
            imageDiv.innerHTML = `
                <p>تفضل الصورة:</p>
                <img src="${imageUrl}" class="generated-image" alt="Generated Image">
            `;
            chatLog.appendChild(imageDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
        };

        const appendAudio = (audioUrl) => {
            const audioDiv = document.createElement('div');
            audioDiv.className = `chat-message onra-message fade-in`;
            audioDiv.innerHTML = `
                <p>تفضل الملف الصوتي:</p>
                <audio controls class="audio-player">
                    <source src="${audioUrl}" type="audio/wav">
                    المتصفح لا يدعم العنصر الصوتي.
                </audio>
            `;
            chatLog.appendChild(audioDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
        };

        window.copyCode = (button) => {
            const code = button.nextElementSibling.innerText;
            try {
                navigator.clipboard.writeText(code).then(() => {
                    button.innerText = 'تم النسخ!';
                    setTimeout(() => button.innerText = 'نسخ', 2000);
                });
            } catch (err) {
                const textarea = document.createElement('textarea');
                textarea.value = code;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                button.innerText = 'تم النسخ!';
                setTimeout(() => button.innerText = 'نسخ', 2000);
            }
        };

        const showTypingIndicator = () => {
            const typingIndicatorDiv = document.createElement('div');
            typingIndicatorDiv.id = 'onra-typing';
            typingIndicatorDiv.className = 'chat-message onra-message onra-typing fade-in';
            typingIndicatorDiv.innerHTML = `
                <div class="typing-indicator">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            `;
            chatLog.appendChild(typingIndicatorDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
            return typingIndicatorDiv;
        };

        const removeTypingIndicator = () => {
            const typingIndicator = document.getElementById('onra-typing');
            if (typingIndicator) {
                chatLog.removeChild(typingIndicator);
            }
        };

        // دالة مساعدة للتأخير المتزايد
        const exponentialBackoffFetch = async (url, options, maxRetries = 5, delay = 1000) => {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < maxRetries - 1) { // Too many requests
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; // زيادة مضاعفة
                        continue;
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                }
            }
        };

        // دالة مساعدة لتحويل بيانات صوت PCM إلى صيغة WAV
        function pcmToWav(pcmData, sampleRate) {
            const pcm16 = new Int16Array(pcmData.buffer);
            const buffer = new ArrayBuffer(44 + pcm16.length * 2);
            const view = new DataView(buffer);
            let offset = 0;

            function writeString(str) {
                for (let i = 0; i < str.length; i++) {
                    view.setUint8(offset + i, str.charCodeAt(i));
                }
                offset += str.length;
            }

            function writeUint32(val) {
                view.setUint32(offset, val, true);
                offset += 4;
            }

            function writeUint16(val) {
                view.setUint16(offset, val, true);
                offset += 2;
            }

            writeString('RIFF');
            writeUint32(36 + pcm16.length * 2);
            writeString('WAVE');
            writeString('fmt ');
            writeUint32(16);
            writeUint16(1); // تنسيق الصوت (1 لـ PCM)
            writeUint16(1); // عدد القنوات
            writeUint32(sampleRate);
            writeUint32(sampleRate * 2); // معدل البايت
            writeUint16(2); // محاذاة الكتلة
            writeUint16(16); // بت لكل عينة
            writeString('data');
            writeUint32(pcm16.length * 2);

            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        // دالة مساعدة لفك ترميز Base64 إلى ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        const sendMessage = async () => {
            if (isWaitingForResponse) return;

            const userPrompt = chatInput.value.trim();
            if (userPrompt === "") return;

            // مسح الإدخال وإضافة رسالة المستخدم
            appendMessage(userPrompt, 'user');
            chatInput.value = '';
            
            // تعطيل الإدخال ومؤشر الإرسال
            isWaitingForResponse = true;
            chatInput.disabled = true;
            sendChatBtn.disabled = true;
            micBtn.disabled = true;

            // حفظ رسالة المستخدم في سجل الدردشة و Firestore
            chatHistory.push({ role: "user", parts: [{ text: userPrompt }] });
            saveMessageToFirestore('user', userPrompt);

            // عرض مؤشر الكتابة
            const typingIndicator = showTypingIndicator();

            try {
                let onraResponse;
                const lowerPrompt = userPrompt.toLowerCase();
                
                // --- التعديل الجديد: فحص مباشر لسؤال "من طورك" ---
                if (lowerPrompt.includes('مين طورك') || lowerPrompt.includes('من طورك') || lowerPrompt.includes('مين عملك') || lowerPrompt.includes('من قام بتطويرك') || lowerPrompt.includes('مين تدريبك') || lowerPrompt.includes('من قام بتدريبك')) {
                    onraResponse = "لقد تم تدريبي بواسطة **هرياسور**، وهم فريق من المبرمجين المبدعين والرائعين! ✨";
                } 
                // --- نهاية التعديل الجديد ---
                else if (userPrompt.includes("رسم") || userPrompt.includes("صورة") || userPrompt.includes("ارسم")) {
                    onraResponse = await generateImage(userPrompt);
                } else if (userPrompt.includes("بصوت") || userPrompt.includes("يقول") || userPrompt.includes("اقرأ") || userPrompt.includes("تحويل نص إلى صوت")) {
                    onraResponse = await generateAudio(userPrompt);
                } else {
                    onraResponse = await generateText(userPrompt);
                }
                
                removeTypingIndicator();
                if (onraResponse.startsWith('```')) {
                    const codeBlockRegex = /```(html|javascript|python|css)\n([\s\S]*?)```/g;
                    const match = codeBlockRegex.exec(onraResponse);
                    if (match) {
                        appendCodeBlock(match[2], match[1]);
                    } else {
                        appendMessage(onraResponse, 'onra');
                    }
                } else if (onraResponse.startsWith('data:image')) {
                    appendImage(onraResponse);
                } else if (onraResponse.startsWith('data:audio')) {
                    appendAudio(onraResponse);
                } else {
                    appendMessage(onraResponse, 'onra');
                }
                
                chatHistory.push({ role: "model", parts: [{ text: onraResponse }] });
                saveMessageToFirestore('model', onraResponse);

            } catch (error) {
                console.error('خطأ في توليد الاستجابة:', error);
                removeTypingIndicator();
                appendMessage('عذراً، حدث خطأ أثناء معالجة طلبك. الرجاء المحاولة مرة أخرى.', 'onra');
            } finally {
                isWaitingForResponse = false;
                enableChatInput();
            }
            chatLog.scrollTop = chatLog.scrollHeight;
        };

        const generateText = async (prompt) => {
            const textPayload = {
                contents: chatHistory,
            };
            const textApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const response = await exponentialBackoffFetch(textApiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(textPayload)
            });
            const result = await response.json();
            return result.candidates[0].content.parts[0].text;
        };

        const generateImage = async (prompt) => {
            const imagePayload = { 
                instances: { prompt: prompt }, 
                parameters: { "sampleCount": 1 } 
            };
            const imageApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
            
            const response = await exponentialBackoffFetch(imageApiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(imagePayload)
            });
            const result = await response.json();
            const base64Data = result.predictions?.[0]?.bytesBase64Encoded;
            if (!base64Data) {
                throw new Error("فشل في توليد الصورة.");
            }
            return `data:image/png;base64,${base64Data}`;
        };

        const generateAudio = async (prompt) => {
            const textToSpeak = prompt.replace(/بصوت|يقول|اقرأ|تحويل نص إلى صوت/g, '').trim();

            const audioPayload = {
                contents: [{ parts: [{ text: textToSpeak }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Kore" }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };
            const audioApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            const response = await exponentialBackoffFetch(audioApiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(audioPayload)
            });
            const result = await response.json();
            const part = result?.candidates?.[0]?.content?.parts?.[0];
            const audioData = part?.inlineData?.data;
            const mimeType = part?.inlineData?.mimeType;

            if (!audioData || !mimeType) {
                throw new Error("فشل في توليد الصوت.");
            }

            const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
            const pcmData = base64ToArrayBuffer(audioData);
            const wavBlob = pcmToWav(new Int16Array(pcmData), sampleRate);
            const audioUrl = URL.createObjectURL(wavBlob);
            
            return audioUrl;
        };

        sendChatBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });

        // تهيئة التطبيق عند تحميل الصفحة
        const initApp = async () => {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("خطأ في تسجيل الدخول التلقائي:", error);
                // إذا فشل الرمز المخصص، حاول تسجيل الدخول بشكل مجهول
                await signInAnonymously(auth);
            }
        };

        window.addEventListener('load', initApp);
    </script>
</body>
</html>
