<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أونرا - مساعدك الذكي</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- showdown.js for Markdown to HTML conversion -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <!-- Google Fonts for a clean look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f0f2f5;
            direction: rtl; /* For RTL support */
        }
        .chat-container {
            max-width: 800px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            background-color: #fff;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .chat-header {
            border-bottom: 2px solid #e2e8f0;
        }
        .chat-log {
            flex-grow: 1;
            overflow-y: auto;
            padding: 24px;
            background-color: #f9fafb;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .chat-message {
            max-width: 85%;
            padding: 12px 20px;
            border-radius: 24px;
            line-height: 1.6;
            word-wrap: break-word;
        }
        .user-message {
            background-color: #e3f2fd;
            color: #1a237e;
            align-self: flex-end; /* Align right for RTL */
        }
        .onra-message {
            background-color: #e8f5e9;
            color: #1b5e20;
            align-self: flex-start; /* Align left for RTL */
        }
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 10;
            left: 0; /* Align to the left for RTL */
            border-radius: 8px;
            overflow: hidden;
        }
        .dropdown-content.show {
            display: block;
        }
        .dropdown-content button, .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            width: 100%;
            text-align: right;
            border: none;
            background: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .dropdown-content button:hover, .dropdown-content a:hover {
            background-color: #f1f1f1;
        }
        .chat-input-container {
            border-top: 2px solid #e2e8f0;
            padding: 16px;
        }
        .chat-input-container input {
            flex-grow: 1;
            border-radius: 30px;
            padding: 12px 20px;
            border: 1px solid #cbd5e1;
            outline: none;
            transition: all 0.2s;
        }
        .chat-input-container input:focus {
            border-color: #4a90e2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
        }
        .chat-input-container button {
            background-color: #4a90e2;
            color: white;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            margin-right: 8px; /* For RTL */
            transition: all 0.2s ease;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .chat-input-container button:hover {
            background-color: #357abd;
            transform: scale(1.05);
        }
        .skeleton {
            animation: pulse 1.5s infinite;
            background-color: #e2e8f0;
            border-radius: 8px;
        }
        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .dot {
            width: 8px;
            height: 8px;
            background-color: #1b5e20;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        .dot:nth-child(3) { animation-delay: 0s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
            100% { transform: scale(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .code-block {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 16px;
            border-radius: 12px;
            margin-top: 10px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            white-space: pre-wrap;
            position: relative;
            direction: ltr;
            text-align: left;
            overflow-x: auto;
        }
        .copy-btn {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #d4d4d4;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .copy-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .generated-image {
            width: 100%;
            border-radius: 12px;
            margin-top: 10px;
        }
        .audio-player {
            width: 100%;
            margin-top: 10px;
        }
        .social-login-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 20px;
            margin: 10px 0;
            font-size: 16px;
            cursor: pointer;
            border: 1px solid #ddd;
            background-color: #fff;
            transition: background-color 0.2s;
        }
        .social-login-btn.google {
            color: #4285F4;
            border-color: #4285F4;
        }
        .social-login-btn.google:hover {
            background-color: #e6f0ff;
        }
        .social-login-btn.facebook {
            color: #1877F2;
            border-color: #1877F2;
        }
        .social-login-btn.facebook:hover {
            background-color: #eaf1fb;
        }
        .social-login-btn svg {
            fill: currentColor;
        }
        /* Modal for confirmation */
        .modal {
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
            direction: rtl;
        }
        .modal-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        .modal-buttons button {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        .modal-buttons button.confirm {
            background-color: #ef4444;
            color: white;
        }
        .modal-buttons button.cancel {
            background-color: #e5e7eb;
            color: #374151;
        }
    </style>
</head>
<body class="p-4 md:p-8 flex justify-center items-center h-screen">

    <div class="chat-container w-full">
        <!-- Chat Header -->
        <header class="chat-header p-6 flex items-center justify-between">
            <!-- Left side with icon and title -->
            <div class="flex items-center gap-4">
                <!-- Onra SVG Icon -->
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#4a90e2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2a10 10 0 0 0-7.3 16.7l-2.4 2.3c-.6.6-1.5-.4-.9-1l2.4-2.3A10 10 0 1 0 12 2z"></path>
                    <path d="M8 12h.01"></path>
                    <path d="M12 12h.01"></path>
                    <path d="M16 12h.01"></path>
                </svg>
                <h1 class="text-3xl font-bold text-gray-800">مساعد الذكاء الاصطناعي أونرا</h1>
            </div>

            <!-- Three dots dropdown menu -->
            <div class="dropdown">
                <button id="dropdownBtn" class="flex items-center justify-center w-10 h-10 text-gray-600 hover:text-gray-800 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM12 9.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM12 16.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5z"/>
                    </svg>
                </button>
                <div id="authMenu" class="dropdown-content">
                    <!-- Authentication, Save and Clear buttons will be rendered here -->
                </div>
            </div>
        </header>

        <!-- Chat Log -->
        <main id="chatLog" class="chat-log text-right">
            <div class="chat-message onra-message fade-in">
                <p>أهلاً بك! أنا أونرا، مساعدك الذكي. المحادثات محفوظة تلقائياً.</p>
            </div>
        </main>

        <!-- Chat Input -->
        <footer class="chat-input-container flex items-center">
            <input type="text" id="chatInput" placeholder="اكتب سؤالك هنا..." class="text-right" />
            <button id="sendChatBtn" title="إرسال">
                <!-- SVG for send icon -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </footer>
    </div>

    <!-- Modal Container -->
    <div id="modal" class="modal hidden">
        <div class="modal-content">
            <p id="modal-text"></p>
            <div class="modal-buttons">
                <button id="modal-confirm" class="confirm">تأكيد</button>
                <button id="modal-cancel" class="cancel">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Firebase CDN Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, serverTimestamp, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (!firebaseConfig) {
            console.error('Firebase configuration is not available. Please run this app in an environment that provides Firebase configuration.');
        }

        // Gemini API Key (managed by the environment)
        const GEMINI_API_KEY = "";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const converter = new showdown.Converter();

        let userId = null;
        let isAuthReady = false;
        let unsubscribeFromChat = null; // Variable to hold the unsubscribe function

        const chatLog = document.getElementById('chatLog');
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');
        const authMenu = document.getElementById('authMenu');
        const dropdownBtn = document.getElementById('dropdownBtn');

        // Modal elements
        const modal = document.getElementById('modal');
        const modalText = document.getElementById('modal-text');
        const modalConfirmBtn = document.getElementById('modal-confirm');
        const modalCancelBtn = document.getElementById('modal-cancel');

        // Function to show a confirmation modal
        const showConfirmationModal = (message, onConfirm) => {
            modalText.textContent = message;
            modal.classList.remove('hidden');
            
            const handleConfirm = () => {
                onConfirm();
                modal.classList.add('hidden');
                modalConfirmBtn.removeEventListener('click', handleConfirm);
                modalCancelBtn.removeEventListener('click', handleCancel);
            };

            const handleCancel = () => {
                modal.classList.add('hidden');
                modalConfirmBtn.removeEventListener('click', handleConfirm);
                modalCancelBtn.removeEventListener('click', handleCancel);
            };

            modalConfirmBtn.addEventListener('click', handleConfirm);
            modalCancelBtn.addEventListener('click', handleCancel);
        };

        // Function to create and append a chat message to the log
        const appendMessage = (message, sender) => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}-message fade-in`;
            // Check for Markdown and render accordingly
            messageDiv.innerHTML = converter.makeHtml(message);
            chatLog.appendChild(messageDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
        };

        // Function to append a generated code block
        const appendCodeBlock = (code) => {
            const codeBlockDiv = document.createElement('div');
            codeBlockDiv.className = `chat-message onra-message fade-in`;
            codeBlockDiv.innerHTML = `
                <p>تمام، هذا هو الكود:</p>
                <div class="code-block">
                    <span class="copy-btn" onclick="copyCode(this)">نسخ</span>
                    <pre><code>${code.trim()}</code></pre>
                </div>
            `;
            chatLog.appendChild(codeBlockDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
        };

        // Function to append a generated image
        const appendImage = (imageUrl) => {
            const imageDiv = document.createElement('div');
            imageDiv.className = `chat-message onra-message fade-in`;
            imageDiv.innerHTML = `
                <p>تفضل الصورة:</p>
                <img src="${imageUrl}" class="generated-image" alt="Generated Image">
            `;
            chatLog.appendChild(imageDiv);
            chatLog.scrollTop = chatLog.log.scrollHeight;
        };

        // Helper function to convert base64 to ArrayBuffer for audio processing
        const base64ToArrayBuffer = (base64) => {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        };

        // Helper function to convert PCM audio to WAV format for playback
        const pcmToWav = (pcmData, sampleRate) => {
            const buffer = new ArrayBuffer(44 + pcmData.length * 2);
            const view = new DataView(buffer);
            const writeString = (view, offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcmData.length * 2, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // audio format (PCM)
            view.setUint16(22, 1, true); // number of channels
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true); // block align
            view.setUint16(34, 16, true); // bits per sample
            writeString(view, 36, 'data');
            view.setUint32(40, pcmData.length * 2, true);
            let offset = 44;
            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(offset, pcmData[i], true);
                offset += 2;
            }
            return new Blob([view], { type: 'audio/wav' });
        };

        // Function to append a generated audio player
        const appendAudio = (audioUrl) => {
            const audioDiv = document.createElement('div');
            audioDiv.className = `chat-message onra-message fade-in`;
            audioDiv.innerHTML = `
                <p>تفضل الملف الصوتي:</p>
                <audio controls class="audio-player">
                    <source src="${audioUrl}" type="audio/wav">
                    المتصفح لا يدعم العنصر الصوتي.
                </audio>
            `;
            chatLog.appendChild(audioDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
        };

        // Function to handle copying code to clipboard
        window.copyCode = (button) => {
            const code = button.nextElementSibling.innerText;
            try {
                navigator.clipboard.writeText(code).then(() => {
                    button.innerText = 'تم النسخ!';
                    setTimeout(() => button.innerText = 'نسخ', 2000);
                });
            } catch (err) {
                // Fallback for browsers that don't support navigator.clipboard
                const textarea = document.createElement('textarea');
                textarea.value = code;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                button.innerText = 'تم النسخ!';
                setTimeout(() => button.innerText = 'نسخ', 2000);
            }
        };

        // Display a typing indicator while waiting for the API response
        const showTypingIndicator = () => {
            const typingIndicatorDiv = document.createElement('div');
            typingIndicatorDiv.id = 'onra-typing';
            typingIndicatorDiv.className = 'chat-message onra-message fade-in';
            typingIndicatorDiv.innerHTML = `
                <div class="typing-indicator">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            `;
            chatLog.appendChild(typingIndicatorDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
            return typingIndicatorDiv;
        };

        // Remove the typing indicator
        const removeTypingIndicator = () => {
            const typingIndicator = document.getElementById('onra-typing');
            if (typingIndicator) {
                chatLog.removeChild(typingIndicator);
            }
        };
        
        // Function to clear chat history from Firestore
        const clearChatHistory = async () => {
            if (!isAuthReady || !userId) {
                return;
            }

            showConfirmationModal('هل أنت متأكد من مسح المحادثة؟ لا يمكن التراجع عن هذا الإجراء.', async () => {
                try {
                    const batch = writeBatch(db);
                    const q = query(collection(db, `artifacts/${appId}/users/${userId}/chatHistory`));
                    const snapshot = await getDocs(q);
                    
                    snapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });

                    await batch.commit();
                    appendMessage('تم مسح المحادثة بنجاح! 👋', 'onra');
                    authMenu.classList.remove('show');
                } catch (error) {
                    console.error("Error clearing chat history:", error);
                    appendMessage("عذراً، حدث خطأ أثناء مسح المحادثة.", 'onra');
                }
            });
        };

        // Authenticate with Firebase and set up listener
        onAuthStateChanged(auth, async (user) => {
            // Clean up any existing listener to prevent duplicates
            if (unsubscribeFromChat) {
                unsubscribeFromChat();
            }

            if (user) {
                userId = user.uid;
                isAuthReady = true;
                setupAuthUI(user);
                console.log("User is signed in with UID:", userId);
                
                // Subscribe to chat history only for authenticated users
                const chatsCollection = collection(db, `artifacts/${appId}/users/${userId}/chatHistory`);
                // Removed orderBy for simplicity and to avoid index issues
                const q = query(chatsCollection);
                
                unsubscribeFromChat = onSnapshot(q, (snapshot) => {
                    const messages = [];
                    snapshot.forEach(doc => {
                        messages.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Sort messages by timestamp in the client to avoid Firestore index issues
                    messages.sort((a, b) => a.timestamp - b.timestamp);

                    chatLog.innerHTML = '';
                    
                    messages.forEach(msg => {
                        if (msg.sender === 'onra_code') {
                            appendCodeBlock(msg.message);
                        } else if (msg.sender === 'onra_image') {
                            appendImage(msg.message);
                        } else if (msg.sender === 'onra_audio') {
                            appendAudio(msg.message);
                        } else {
                            appendMessage(msg.message, msg.sender);
                        }
                    });

                    if (messages.length === 0) {
                        appendMessage('أهلاً بك! أنا أونرا، مساعدك الذكي. المحادثات محفوظة تلقائياً.', 'onra');
                    }
                }, (error) => {
                    console.error("Firestore snapshot listener error:", error);
                    if (error.code === 'permission-denied') {
                        chatLog.innerHTML = `<div class="chat-message onra-message fade-in"><p>عذراً، لا يمكنني تحميل المحادثات. يرجى التأكد من أنك قمت بتسجيل الدخول.</p></div>`;
                    }
                });

            } else {
                // When a user is logged out, set a temporary ID and display the welcome message
                userId = crypto.randomUUID();
                isAuthReady = true;
                setupAuthUI(user);
                console.log("User is signed out or anonymous. Using temporary ID:", userId);
                chatLog.innerHTML = `<div class="chat-message onra-message fade-in"><p>أهلاً بك! أنا أونرا، مساعدك الذكي. المحادثات محفوظة تلقائياً.</p></div>`;
            }
        });

        // Initial sign-in with the custom token provided by the environment
        const initialSignIn = async () => {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth Error:", error);
            }
        };

        // Renders the authentication menu
        const setupAuthUI = (user) => {
            authMenu.innerHTML = '';
            if (user) {
                const welcomeMessage = document.createElement('div');
                welcomeMessage.className = "px-4 py-2 text-right text-sm text-gray-700";
                welcomeMessage.textContent = user.isAnonymous ? 'مرحباً، أيها الزائر!' : `مرحباً, ${user.uid.slice(0, 8)}...`;
                authMenu.appendChild(welcomeMessage);
                
                // Add the user ID to the UI for debugging and multi-user apps
                const userIdDisplay = document.createElement('div');
                userIdDisplay.className = "px-4 py-2 text-right text-xs text-gray-500 overflow-hidden text-ellipsis whitespace-nowrap";
                userIdDisplay.textContent = `معرف المستخدم: ${user.uid}`;
                authMenu.appendChild(userIdDisplay);

                // Add the "Clear Chat" button
                const clearChatBtn = document.createElement('button');
                clearChatBtn.textContent = 'مسح المحادثة';
                clearChatBtn.onclick = clearChatHistory;
                authMenu.appendChild(clearChatBtn);

                const signOutBtn = document.createElement('button');
                signOutBtn.textContent = 'تسجيل خروج';
                signOutBtn.onclick = async () => {
                    try {
                        await signOut(auth);
                        appendMessage('تم تسجيل خروجك بنجاح. أهلاً بك مرة أخرى!', 'onra');
                        authMenu.classList.remove('show');
                    } catch (error) {
                        console.error("Sign out error:", error);
                    }
                };
                authMenu.appendChild(signOutBtn);
            } else {
                const guestLoginBtn = document.createElement('button');
                guestLoginBtn.textContent = 'دخول كزائر';
                guestLoginBtn.className = "social-login-btn";
                guestLoginBtn.onclick = async () => {
                    try {
                        await signInAnonymously(auth);
                        appendMessage('تم تسجيل دخولك كزائر!', 'onra');
                        authMenu.classList.remove('show');
                    } catch (error) {
                        console.error("Guest login error:", error);
                        appendMessage('عذراً، حدث خطأ في تسجيل الدخول كزائر. حاول مرة أخرى.', 'onra');
                    }
                };
                authMenu.appendChild(guestLoginBtn);
            }
        };

        // Main function to send a message and handle AI response
        const sendMessage = async () => {
            const message = chatInput.value.trim();
            // Added an explicit check for userId to prevent race conditions on the first message.
            if (!message || !isAuthReady || !userId) {
                console.log("Message not sent. isAuthReady:", isAuthReady, "userId:", userId);
                return;
            }

            const userMessage = {
                message: message,
                sender: 'user',
                timestamp: Date.now()
            };
            
            // Add user message to Firestore
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/chatHistory`), userMessage);
            } catch (error) {
                console.error("Error adding message to Firestore:", error);
                // On-screen message might be redundant due to onSnapshot, but good for debugging.
                // appendMessage("عذراً، حدث خطأ في حفظ رسالتك. حاول مرة أخرى.", 'onra');
            }

            chatInput.value = '';
            const typingIndicator = showTypingIndicator();

            try {
                const lowerCaseMessage = message.toLowerCase();

                if (lowerCaseMessage.includes('ارسم') || lowerCaseMessage.includes('صورة') || lowerCaseMessage.includes('صور') || lowerCaseMessage.includes('مولد صور')) {
                    const imagePrompt = message.replace(/^(ارسم|صورة|صور|مولد صور).*/, '').trim() || "صورة فنية جميلة";
                    const payload = {
                        instances: { prompt: imagePrompt },
                        parameters: { "sampleCount": 1 }
                    };
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    const base64Data = result?.predictions?.[0]?.bytesBase64Encoded;
                    if (base64Data) {
                        const imageUrl = `data:image/png;base64,${base64Data}`;
                        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/chatHistory`), {
                            message: imageUrl,
                            sender: 'onra_image',
                            timestamp: Date.now()
                        });
                    } else {
                        throw new Error('No image data found.');
                    }
                }
                else if (lowerCaseMessage.includes('قول') || lowerCaseMessage.includes('صوت') || lowerCaseMessage.includes('كلمات') || lowerCaseMessage.includes('اقرا')) {
                    const ttsText = message.replace(/^(قول|صوت|كلمات|اقرا).*/, '').trim() || "أهلاً بك أيها الصديق، يسعدني أن أتحدث إليك.";
                    const payload = {
                        contents: [{ parts: [{ text: ttsText }] }],
                        generationConfig: {
                            responseModality: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } }
                        },
                        model: "gemini-2.5-flash-preview-tts"
                    };
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    const audioPart = result.candidates?.[0]?.content?.parts?.[0];
                    if (audioPart && audioPart.inlineData && audioPart.inlineData.data) {
                        const base64Audio = audioPart.inlineData.data;
                        const sampleRate = parseInt(audioPart.inlineData.mimeType.match(/rate=(\d+)/)[1], 10);
                        const pcmData = new Int16Array(base64ToArrayBuffer(base64Audio));
                        const wavBlob = pcmToWav(pcmData, sampleRate);
                        const audioUrl = URL.createObjectURL(wavBlob);
                        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/chatHistory`), {
                            message: audioUrl,
                            sender: 'onra_audio',
                            timestamp: Date.now()
                        });
                    } else {
                        throw new Error('No audio data found.');
                    }
                }
                else {
                    const chatHistory = [];
                    // Fetch existing chat history from Firestore
                    const snapshot = await getDocs(collection(db, `artifacts/${appId}/users/${userId}/chatHistory`));
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        chatHistory.push({ role: data.sender === 'user' ? 'user' : 'model', parts: [{ text: data.message }] });
                    });

                    // Add the new, revised persona prompt at the beginning of the chat history
                    const personaPrompt = {
                        role: 'user',
                        parts: [
                            { text: 'أنت أونرا، مساعد ذكاء اصطناعي ودود وذكي. مهمتك هي الإجابة على الأسئلة بشكل مباشر وفعال. استخدم نبرة حيوية، معبرة، وودية في كلامك. كن مستعداً لتقديم المساعدة الإبداعية عند الحاجة أو إذا شعرت بأنها مفيدة للمستخدم. اجعل إجاباتك منظمة وسهلة الفهم، مع لمسة من الحماس والود.' }
                        ]
                    };

                    const payload = { contents: [personaPrompt, ...chatHistory] };
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error.message || response.statusText);
                    }

                    const result = await response.json();
                    const aiResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (aiResponse) {
                        const codeBlockRegex = /```(html|javascript|python|css)\n([\s\S]*?)```/g;
                        const match = codeBlockRegex.exec(aiResponse);

                        if (match) {
                            await addDoc(collection(db, `artifacts/${appId}/users/${userId}/chatHistory`), {
                                message: match[2],
                                sender: 'onra_code',
                                timestamp: Date.now()
                            });
                        } else {
                            await addDoc(collection(db, `artifacts/${appId}/users/${userId}/chatHistory`), {
                                message: aiResponse,
                                sender: 'onra',
                                timestamp: Date.now()
                            });
                        }
                    } else {
                        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/chatHistory`), {
                            message: "معذرة، لا أستطيع الإجابة الآن. حاول مرة أخرى.",
                            sender: 'onra',
                            timestamp: Date.now()
                        });
                    }
                }
            } catch (error) {
                console.error("API Error or Firestore error:", error);
                removeTypingIndicator();
                appendMessage(`حدث خطأ: ${error.message}`, 'onra');
            } finally {
                removeTypingIndicator();
            }
        };

        // New event listener for the dropdown button
        dropdownBtn.addEventListener('click', () => {
            authMenu.classList.toggle('show');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (event) => {
            if (!event.target.closest('.dropdown')) {
                authMenu.classList.remove('show');
            }
        });

        sendChatBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        if(firebaseConfig){
            initialSignIn();
        } else {
            // Display welcome message for non-canvas environments
            chatLog.innerHTML = `<div class="chat-message onra-message fade-in"><p>أهلاً بك! هذا التطبيق مصمم للعمل في بيئة مخصصة. قد لا تعمل بعض الميزات بالكامل في بيئة خارجية.</p></div>`;
        }

    </script>
</body>
</html>
